#!/bin/bash

# Usage information
usage() {
  echo "Usage: switchenv <environment>"
  echo "Supported environments:"
  echo "  peer    - Sets Bazel to 6.5.0 and K8s context to arn:aws:eks:eu-central-1:340291253219:cluster/stage-peer"
  echo "  toothly - Sets Bazel to 8.1.1 and K8s context to k3d-toothly-cluster"
  exit 1
}

# Check if an argument was provided
if [ $# -ne 1 ]; then
  usage
fi

ENV="$1"
CONFIG_FILE=~/.config/zsh/conf-peer.zsh

# Handle different environments
case "$ENV" in
"peer")
  BAZEL_VERSION="6.5.0"
  KUBE_CONTEXT="arn:aws:eks:eu-central-1:340291253219:cluster/stage-peer"
  ;;
"toothly")
  BAZEL_VERSION="8.1.1"
  KUBE_CONTEXT="k3d-toothly-cluster"
  ;;
*)
  echo "Error: Unknown environment '$ENV'"
  usage
  ;;
esac

# Update the zsh config file
echo "Updating Bazel version in $CONFIG_FILE to $BAZEL_VERSION..."
# Create directory if it doesn't exist
mkdir -p $(dirname "$CONFIG_FILE")

# Check if file exists
if [ -f "$CONFIG_FILE" ]; then
  # Check if file contains the export line
  if grep -q "export USE_BAZEL_VERSION=" "$CONFIG_FILE"; then
    # For macOS, use different sed syntax or alternative approach
    TMP_FILE=$(mktemp)
    cat "$CONFIG_FILE" | sed "s/export USE_BAZEL_VERSION=.*/export USE_BAZEL_VERSION=$BAZEL_VERSION/" >"$TMP_FILE"
    mv "$TMP_FILE" "$CONFIG_FILE"
  else
    # Append to file if the export line doesn't exist
    echo "export USE_BAZEL_VERSION=$BAZEL_VERSION" >>"$CONFIG_FILE"
  fi
else
  # Create new file
  echo "export USE_BAZEL_VERSION=$BAZEL_VERSION" >"$CONFIG_FILE"
fi

# Switch Kubernetes context
echo "Switching Kubernetes context to $KUBE_CONTEXT..."
kubectl config use-context "$KUBE_CONTEXT"

# Set environment variable in current shell
export USE_BAZEL_VERSION=$BAZEL_VERSION

# Update tmux environment if running in tmux
if [ -n "$TMUX" ]; then
  echo "Updating tmux environment variables..."
  # Set the global tmux environment variable
  tmux set-environment -g USE_BAZEL_VERSION "$BAZEL_VERSION"
  
  # Create a direct export command to send to each pane
  EXPORT_CMD="export USE_BAZEL_VERSION=$BAZEL_VERSION"
  
  # Get the current pane ID to avoid sending to our current pane
  CURRENT_PANE=$(tmux display-message -p "#{session_name}:#{window_index}.#{pane_index}")
  
  # Send the export command to all panes except the current one
  tmux list-panes -a -F "#{session_name}:#{window_index}.#{pane_index}" | while read -r pane; do
    if [ "$pane" != "$CURRENT_PANE" ]; then
      tmux send-keys -t "$pane" "$EXPORT_CMD" C-m
    fi
  done
  
  echo "Environment variables updated in all tmux panes."
  echo "Note: For some complex shell configurations, you may need to run 'source $CONFIG_FILE' manually in specific panes."
fi

echo "Environment '$ENV' loaded successfully!"
echo "- Bazel version: $BAZEL_VERSION"
echo "- Kubernetes context: $KUBE_CONTEXT"

# Instructions for manual sourcing if needed
echo ""
echo "To ensure the environment is loaded in your current shell, you can run:"
echo "  source $CONFIG_FILE"
