#!/bin/bash

# Usage information
usage() {
  echo "Usage: switchenv <environment>"
  echo "Supported environments:"
  echo "  peer    - Sets Bazel to 6.5.0 and K8s context to arn:aws:eks:eu-central-1:340291253219:cluster/stage-peer"
  echo "  toothly - Sets Bazel to 8.1.1 and K8s context to k3d-toothly-cluster"
  exit 1
}

# Check if an argument was provided
if [ $# -ne 1 ]; then
  usage
fi

ENV="$1"
CONFIG_FILE=~/.config/zsh/conf-peer.zsh

# Handle different environments
case "$ENV" in
"peer")
  BAZEL_VERSION="6.5.0"
  KUBE_CONTEXT="arn:aws:eks:eu-central-1:340291253219:cluster/stage-peer"
  ;;
"toothly")
  BAZEL_VERSION="8.1.1"
  KUBE_CONTEXT="k3d-toothly-cluster"
  ;;
*)
  echo "Error: Unknown environment '$ENV'"
  usage
  ;;
esac

# Update the zsh config file
echo "Updating Bazel version in $CONFIG_FILE to $BAZEL_VERSION..."
# Create directory if it doesn't exist
mkdir -p $(dirname "$CONFIG_FILE")

# Check if file exists
if [ -f "$CONFIG_FILE" ]; then
  # Check if file contains the export line
  if grep -q "export USE_BAZEL_VERSION=" "$CONFIG_FILE"; then
    # For macOS, use different sed syntax or alternative approach
    TMP_FILE=$(mktemp)
    cat "$CONFIG_FILE" | sed "s/export USE_BAZEL_VERSION=.*/export USE_BAZEL_VERSION=$BAZEL_VERSION/" >"$TMP_FILE"
    mv "$TMP_FILE" "$CONFIG_FILE"
  else
    # Append to file if the export line doesn't exist
    echo "export USE_BAZEL_VERSION=$BAZEL_VERSION" >>"$CONFIG_FILE"
  fi
else
  # Create new file
  echo "export USE_BAZEL_VERSION=$BAZEL_VERSION" >"$CONFIG_FILE"
fi

# Switch Kubernetes context
echo "Switching Kubernetes context to $KUBE_CONTEXT..."
kubectl config use-context "$KUBE_CONTEXT"

# Set environment variable in current shell
export USE_BAZEL_VERSION=$BAZEL_VERSION

# Update tmux environment if running in tmux
if [ -n "$TMUX" ]; then
  echo "Updating tmux environment variables..."
  
  # Set the global tmux environment variable
  tmux set-environment -g USE_BAZEL_VERSION "$BAZEL_VERSION"
  
  # Make sure USE_BAZEL_VERSION is in the update-environment list
  if ! tmux show-options -g | grep -q "update-environment.*USE_BAZEL_VERSION"; then
    # Get current update-environment value
    CURRENT_UPDATE_ENV=$(tmux show-options -g update-environment | awk '{$1=""; print $0}' | sed 's/^[[:space:]]*//')
    
    # Add USE_BAZEL_VERSION if not already present
    if [[ "$CURRENT_UPDATE_ENV" != *"USE_BAZEL_VERSION"* ]]; then
      # Remove quotes if present
      CURRENT_UPDATE_ENV=$(echo "$CURRENT_UPDATE_ENV" | sed 's/^"\(.*\)"$/\1/')
      
      # Add our variable and set the option
      NEW_UPDATE_ENV="\"$CURRENT_UPDATE_ENV USE_BAZEL_VERSION\""
      tmux set-option -g update-environment "$NEW_UPDATE_ENV"
    fi
  fi
  
  # Create a temporary script to update environment in all panes
  TMUX_UPDATE_SCRIPT=$(mktemp)
  cat << EOF > "$TMUX_UPDATE_SCRIPT"
#!/bin/bash
export USE_BAZEL_VERSION=$BAZEL_VERSION
EOF
  chmod +x "$TMUX_UPDATE_SCRIPT"
  
  # Get current pane ID to avoid sending to our current pane twice
  CURRENT_PANE=$(tmux display-message -p "#{pane_id}")
  
  # Send the command to all panes in all sessions
  echo "Updating environment in all tmux panes..."
  for pane_id in $(tmux list-panes -a -F "#{pane_id}"); do
    # Use the unique pane ID to target the specific pane
    tmux send-keys -t "$pane_id" "export USE_BAZEL_VERSION=$BAZEL_VERSION" C-m
  done
  
  # Clean up
  rm "$TMUX_UPDATE_SCRIPT"
  
  echo "Environment variable set in tmux global environment and all panes."
  echo "New panes will inherit this environment variable automatically."
  
  # Create a helper script for manual updates if needed
  cat << 'EOF' > /tmp/tmux_update_env.sh
#!/bin/bash
# Helper script to update environment variables from tmux
if [ -n "$TMUX" ]; then
  # Get all environment variables from tmux
  eval $(tmux show-environment -g | grep -v "^-")
  echo "Environment updated from tmux global environment."
else
  echo "Not running in tmux."
fi
EOF
  chmod +x /tmp/tmux_update_env.sh
  
  echo ""
  echo "If you need to manually update the environment in a specific pane, you can run:"
  echo "  source /tmp/tmux_update_env.sh"
fi

echo "Environment '$ENV' loaded successfully!"
echo "- Bazel version: $BAZEL_VERSION"
echo "- Kubernetes context: $KUBE_CONTEXT"

# Instructions for manual sourcing if needed
echo ""
echo "To ensure the environment is loaded in your current shell, you can run:"
echo "  source $CONFIG_FILE"
